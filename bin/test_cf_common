#!/bin/sh

setUp() {
    export BUILDPACK_PATH=/tmp/cf_common_spec
    mkdir -p $BUILDPACK_PATH
    rm -rf $BUILDPACK_PATH/dependencies
}

tearDown() {
    unset BUILDPACK_PATH
}

testCurlIsNotOveriddenWhenThereAreNoDependencies() {
    source $BASE/cf_common

    assertFalse 'curl is not overidden' $(is_a_custom_function curl)
}

testCurlIsOveriddenWhenThereAreDependencies() {
    mkdir $BUILDPACK_PATH/dependencies
    source $BASE/cf_common

    assertTrue 'curl is overidden' $(is_a_custom_function curl)
}

testCurlWhenTheFileDoesNotExistAsADependency() {
    mkdir $BUILDPACK_PATH/dependencies
    source $BASE/cf_common

    expected_output="Expected dependency to exist but could not find it: http://files.com/file.txt"

    assertEquals "$expected_output" "$(curl http://files.com/file.txt -s 2>&1)"
}

testCurlWhenTheFileFromTheUrlIsStreamed() {
    mkdir $BUILDPACK_PATH/dependencies
    source $BASE/cf_common
    touch $BUILDPACK_PATH/dependencies/http___files.com_file.txt
    echo 'some text' > $BUILDPACK_PATH/dependencies/http___files.com_file.txt

    assertEquals 'some text' "$(curl http://files.com/file.txt -s)"
}

testCurlWhenTheFileFromTheUrlIsWrittenToAnOutputFile() {
    mkdir $BUILDPACK_PATH/dependencies
    source $BASE/cf_common
    touch $BUILDPACK_PATH/dependencies/http___files.com_file.txt
    echo 'some text' > $BUILDPACK_PATH/dependencies/http___files.com_file.txt

    curl -s -L -o $BUILDPACK_PATH/dependencies/output_file.txt http://files.com/file.txt

    assertEquals 'some text' "$(cat $BUILDPACK_PATH/dependencies/output_file.txt)"
}

testCurlSupportsHttpsWhenOveridden() {
    mkdir $BUILDPACK_PATH/dependencies
    source $BASE/cf_common
    touch $BUILDPACK_PATH/dependencies/https___files.com_file.txt
    echo 'some text' > $BUILDPACK_PATH/dependencies/https___files.com_file.txt

    assertEquals 'some text' "$(curl https://files.com/file.txt -s)"
}

# ==================================== Utilities ====================================
function is_a_custom_function() {
    name=$1

    if type $name | grep -q 'is a function$' 2>/dev/null
    then
        echo '0';
    else
        echo '1';
    fi
}

BASE="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
source $BASE/../vendor/shunit2