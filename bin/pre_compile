#!/usr/bin/env bash

# This script serves as the
# [**Python Buildpack**](https://github.com/keacloud/heroku-buildpack-python)
# pre-compiler.
#
# A [buildpack](https://devcenter.heroku.com/articles/buildpacks) is an
# adapter between a Python application and Heroku's runtime.

# ## Usage
# Compiling an app into a slug is simple:
#
#     $ bin/pre_compile BUILD_DIR BIN_DIR

BIN_DIR=$(cd "$(dirname "$0")"; pwd) # absolute path
BUILD_DIR=$1

# Check for coconut files
if compgen -G "$BUILD_DIR/**/*.coco" > /dev/null; then
    if [ ! "$SKIP_COCONUT_COMPILE" ]; then
        puts-step "Installing compiler"
        /app/.heroku/python/bin/pip install --disable-pip-version-check --exists-action=w --src=/app/.heroku/src coconut[all] 2>&1 | tee "$WARNINGS_LOG" | cleanup | indent

        puts-step "Compilng .coco files"
        TARGET=$COCONUT_TARGET || "universal"
        ARGS=$COCONUT_ARGS || ""

        coconut . . --package --force --target $TARGET $ARGS 2>&1 | tee "$WARNINGS_LOG" | cleanup | indent

    fi
fi
