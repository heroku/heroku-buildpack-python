#!/usr/bin/env bash

set -euo pipefail

# This is set by bob-builder from the "Build Path" comment line in the
# build formula script that sourced this one.
OUT_PREFIX=$1
# The filename of the script that sourced this one (e.g. `python-3.10.0`).
FORMULA_FILENAME=$(basename "${0}")
# The version component (e.g. `3.10.0`).
VERSION=$(echo "${FORMULA_FILENAME}" | cut --delimiter '-' --fields 2)

echo "Building Python ${VERSION}..."

if [[ "${STACK}" != "heroku-18" && "${STACK}" != "heroku-20" && "${VERSION}" == 3.[7-8].* ]]; then
  echo "Python 3.7 and 3.8 are only supported on Heroku-20 and older!" >&2
  echo "Override the default stacks list using: STACKS='heroku-18 heroku-20'" >&2
  exit 1
fi

# See: https://www.python.org/downloads/ -> "OpenPGP Public Keys"
case "${VERSION}" in
  3.10.*)
    # https://keybase.io/pablogsal/
    GPG_KEY_FINGERPRINT='A035C8C19219BA821ECEA86B64E628F8D684696D'
    ;;
  3.[8-9].*)
    # https://keybase.io/ambv/
    GPG_KEY_FINGERPRINT='E3FF2839C048B25C084DEBE9B26995E310250568'
    ;;
  3.7.*)
    # https://keybase.io/nad/
    GPG_KEY_FINGERPRINT='0D96DF4D4110E5C43FBFB17F2D347EA6AA65421D'
    ;;
  *)
    echo "Unsupported Python version!" >&2
    exit 1
    ;;
esac

SOURCE_URL="https://www.python.org/ftp/python/${VERSION}/Python-${VERSION}.tgz"
SIGNATURE_URL="${SOURCE_URL}.asc"

set -o xtrace

curl --fail --retry 3 --retry-connrefused --connect-timeout 5 --max-time 60 -o python.tgz "${SOURCE_URL}"
curl --fail --retry 3 --retry-connrefused --connect-timeout 5 --max-time 60 -o python.tgz.asc "${SIGNATURE_URL}"

# Skip GPG verification on Heroku-18 since it fails to fetch keys:
# `gpg: keyserver receive failed: Server indicated a failure`
if [[ "${STACK}" != "heroku-18" ]]; then
  gpg --batch --verbose --recv-keys "${GPG_KEY_FINGERPRINT}"
  gpg --batch --verify python.tgz.asc python.tgz
fi

mkdir src
tar --extract --file python.tgz --strip-components=1 --directory src/
cd src

# Aim to keep this roughly consistent with the options used in the Python Docker images,
# for maximum compatibility / most battle-tested build configuration:
# https://github.com/docker-library/python
CONFIGURE_OPTS=(
  # Support loadable extensions in the `_sqlite` extension module.
  "--enable-loadable-sqlite-extensions"
  # Make autoconf's configure option validation more strict.
  "--enable-option-checking=fatal"
  # Install Python into `/app/.heroku/python` rather than the default of `/usr/local`.
  "--prefix=${OUT_PREFIX}"
  # Skip running `ensurepip` as part of install, since the buildpack installs a curated
  # version of pip itself (which ensures it's consistent across Python patch releases).
  "--with-ensurepip=no"
  # Build the `pyexpat` module using the `expat` library in the stack image (which will
  # automatically receive security updates), rather than CPython's vendored version.
  "--with-system-expat"
)

if [[ "${VERSION}" != 3.7.* ]]; then
  CONFIGURE_OPTS+=(
    # Python 3.7 and older run the whole test suite for PGO, which takes
    # much too long. Whilst this can be overridden via `PROFILE_TASK`, we
    # prefer to change as few of the upstream build options as possible.
    # As such, PGO is only enabled for Python 3.8+.
    "--enable-optimizations"
  )
fi

if [[ "${VERSION}" == 3.10.* ]]; then
  CONFIGURE_OPTS+=(
    # Shared builds are beneficial for a number of reasons:
    # - Reduces the size of the build, since it avoids the duplication between
    #   the Python binary and the static library.
    # - Permits use-cases that only work with the shared Python library,
    #   and not the static library (such as `pycall.rb` or `PyO3`).
    # - More consistent with the official Python Docker images and other distributions.
    #
    # However, shared builds are slower unless `no-semantic-interposition`and LTO is used:
    # https://fedoraproject.org/wiki/Changes/PythonNoSemanticInterpositionSpeedup
    #
    # It's only as of Python 3.10 that `no-semantic-interposition` is enabled by default,
    # so we only use shared builds on Python 3.10+ to avoid needing to override the default
    # compiler flags.
    "--enable-shared"
    "--with-lto"
    # Counter-intuitively, the static library is still generated by default even when
    # the shared library is enabled, so we disable it to reduce the build size.
    "--without-static-libpython"
  )
fi

./configure "${CONFIGURE_OPTS[@]}"

# Using LDFLAGS we instruct the linker to omit all symbol information from the final binary
# and shared libraries, to reduce the size of the build. We have to use `--strip-all` and
# not `--strip-unneeded` since `ld` only understands the former (unlike the `strip` command),
# however it's safe to use since these options don't apply to static libraries.
make -j "$(nproc)" LDFLAGS='-Wl,--strip-all'
make install

if [[ "${VERSION}" == 3.[7-9].* ]]; then
  # On older versions of Python we're still building the static library, which has to be
  # manually stripped since the linker stripping enabled in LDFLAGS doesn't cover them.
  # We're using `--strip-unneeded` since `--strip-all` would remove the `.symtab` section
  # that is required for static libraries to be able to be linked.
  # `find` is used since there are multiple copies of the static library in version-specific
  # locations, eg:
  #   - `lib/libpython3.9.a`
  #   - `lib/python3.9/config-3.9-x86_64-linux-gnu/libpython3.9.a`
  find "${OUT_PREFIX}" -type f -name '*.a' -print -exec strip --strip-unneeded '{}' +
elif ! find "${OUT_PREFIX}" -type f -name '*.a' -print -exec false '{}' +; then
  echo "Unexpected static libraries found!" >&2
  exit 1
fi

# Remove unneeded test directories, similar to the official Docker Python images:
# https://github.com/docker-library/python
# TODO: Explore using --disable-test-modules once the PGO fix is in a released Python version:
# https://bugs.python.org/issue45668
find "${OUT_PREFIX}" -depth -type d -a \( -name 'test' -o -name 'tests' -o -name 'idle_test' \) -print -exec rm -rf '{}' +

# The `make install` step automatically generates `.pyc` files for the stdlib, however:
# - It generates these using the default `timestamp` invalidation mode, which does
#   not work well with the CNB file timestamp normalisation behaviour. As such, we
#   must use one of the hash-based invalidation modes to prevent the `.pyc`s from
#   always being treated as outdated and so being regenerated at application boot.
# - It generates `.pyc`s for all three optimisation levels (standard, -O and -OO),
#   when the vast majority of apps only use the standard mode. As such, we can skip
#   regenerating/shipping those `.opt-{1,2}.pyc` files, reducing build output by 18MB.
#
# We use the `unchecked-hash` mode rather than `checked-hash` since it improves app startup
# times by ~5%, and is only an issue if manual edits are made to the stdlib, which is not
# something we support.
#
# See:
# https://docs.python.org/3/reference/import.html#cached-bytecode-invalidation
# https://docs.python.org/3/library/compileall.html
# https://peps.python.org/pep-0488/
# https://peps.python.org/pep-0552/
find "${OUT_PREFIX}" -depth -type f -name "*.pyc" -delete
# We use the Python binary from the original build output in the source directory,
# rather than the installed binary in `$OUT_PREFIX`, for parity with the automatic
# `.pyc` generation run by `make install`:
# https://github.com/python/cpython/blob/v3.10.4/Makefile.pre.in#L1603-L1629
LD_LIBRARY_PATH="${PWD}" ./python -m compileall -f --invalidation-mode unchecked-hash --workers 0 "${OUT_PREFIX}"

# Support using Python 3 via the version-less `python` command, for parity with virtualenvs,
# the Python Docker images and to also ensure buildpack Python shadows any installed system
# Python, should that provide a version-less alias too.
# This symlink must be relative, to ensure that the Python install remains relocatable.
ln -srvT "${OUT_PREFIX}/bin/python3" "${OUT_PREFIX}/bin/python"

du --max-depth 1 --human-readable "${OUT_PREFIX}"
